{% extends "layout.html" %}

{% block title %}Conversation - CS50 Final Project{% endblock %}

{% block head %}
<style>
    main.page-content {
        padding: 0;
        margin: 0;
        min-height: calc(100vh - 80px);
    }
    
    .conversation-container {
        width: 100%;
        margin: 0;
        padding: 1.5rem;
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
    }

    .appointment-info {
        background: #f8f8f8;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
        color: #666;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .appointment-info strong {
        color: #1c1c1c;
    }

    .end-appointment-button {
        padding: 0.5rem 1.25rem;
        font-size: 0.9rem;
        font-weight: 600;
        color: #ffffff;
        background: #dc3545;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .end-appointment-button:hover {
        background: #c82333;
    }

    .end-appointment-button:active {
        transform: scale(0.98);
    }

    .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        min-height: 0;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        display: flex;
        flex-direction: column;
        max-width: 80%;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        align-self: flex-end;
    }

    .message.assistant {
        align-self: flex-start;
    }

    .message-bubble {
        padding: 0.875rem 1.25rem;
        border-radius: 12px;
        word-wrap: break-word;
        line-height: 1.6;
        white-space: pre-wrap; /* Preserve line breaks and whitespace */
    }
    
    .message-bubble strong {
        font-weight: 600;
    }
    
    .message-bubble ol,
    .message-bubble ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }
    
    .message-bubble ul ul {
        margin: 0.25rem 0;
        padding-left: 1.5rem;
        list-style-type: disc;
    }
    
    .message-bubble li {
        margin: 0.25rem 0;
    }
    
    .message-bubble li ul {
        margin-top: 0.25rem;
        margin-bottom: 0.25rem;
    }
    
    .message-bubble p {
        margin: 0.5rem 0;
    }
    
    .message-bubble p:first-child {
        margin-top: 0;
    }
    
    .message-bubble p:last-child {
        margin-bottom: 0;
    }
    
    .message-bubble h1,
    .message-bubble h2,
    .message-bubble h3,
    .message-bubble h4 {
        font-weight: 600;
        margin: 1rem 0 0.5rem 0;
        color: #1c1c1c;
    }
    
    .message-bubble h1 {
        font-size: 1.5rem;
    }
    
    .message-bubble h2 {
        font-size: 1.3rem;
    }
    
    .message-bubble h3 {
        font-size: 1.4rem;
        font-weight: 700;
    }
    
    .message-bubble h4 {
        font-size: 1rem;
    }
    
    .message-bubble h1:first-child,
    .message-bubble h2:first-child,
    .message-bubble h3:first-child,
    .message-bubble h4:first-child {
        margin-top: 0;
    }

    .message.user .message-bubble {
        background: #4a6fa5;
        color: #ffffff;
        border-bottom-right-radius: 4px;
    }

    .message.assistant .message-bubble {
        background: #f0f0f0;
        color: #1c1c1c;
        border-bottom-left-radius: 4px;
    }

    .message-label {
        font-size: 0.75rem;
        color: #666;
        margin-bottom: 0.25rem;
        font-weight: 600;
    }

    .chat-input-container {
        padding: 1.5rem;
        border-top: 1px solid #e0e0e0;
        background: #ffffff;
    }

    .chat-input-form {
        display: flex;
        gap: 0.75rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.875rem 1rem;
        font-size: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        resize: none;
        font-family: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .chat-input:focus {
        outline: none;
        border-color: #8eaed6;
        box-shadow: 0 0 0 3px rgba(142, 174, 214, 0.1);
    }

    .send-button {
        padding: 0.875rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        color: #ffffff;
        background: #4a6fa5;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .send-button:hover:not(:disabled) {
        background: #3d5a8a;
    }

    .send-button:active:not(:disabled) {
        transform: scale(0.98);
    }

    .send-button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .loading {
        display: none;
        padding: 0.5rem;
        color: #666;
        font-style: italic;
    }

    .loading.show {
        display: block;
    }

    @media (max-width: 640px) {
        .conversation-container {
            padding: 1rem;
            height: calc(100vh - 150px);
        }

        .message {
            max-width: 90%;
        }
    }
</style>
{% endblock %}

{% block body %}
<div class="conversation-container">
    <div class="appointment-info">
        <div>
            <strong>Appointment Details:</strong> 
            Patient: {{ appointment.patient_name }} | 
            Date: {{ appointment.date }}, Time: {{ appointment.time }} | 
            Age: {{ appointment.age_years }} years | 
            Gender: {{ appointment.gender|capitalize }}
        </div>
        <button class="end-appointment-button" id="endAppointmentBtn">End Appointment</button>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- Initial greeting will be added via JavaScript to ensure proper formatting -->
        </div>
        <div class="chat-input-container">
            <form class="chat-input-form" id="chatForm">
                <textarea class="chat-input" id="chatInput" rows="1" placeholder="Type your message here..." required></textarea>
                <button type="submit" class="send-button" id="sendButton">Send</button>
            </form>
            <div class="loading" id="loading">Pediatrician is typing...</div>
        </div>
    </div>
</div>

<script>
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    const sendButton = document.getElementById('sendButton');
    const loading = document.getElementById('loading');

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = chatInput.value.trim();
        if (!message) return;

        // Add user message to chat
        addMessage('user', message);
        chatInput.value = '';
        chatInput.style.height = 'auto';
        
        // Disable input and show loading
        chatInput.disabled = true;
        sendButton.disabled = true;
        loading.classList.add('show');

        try {
            const response = await fetch('{{ url_for("conversation_page") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            
            if (response.ok) {
                addMessage('assistant', data.message);
            } else {
                // Show the actual error message if available, otherwise generic message
                const errorMsg = data.message || data.error || 'Sorry, I encountered an error. Please try again.';
                console.error('Error from server:', data);
                addMessage('assistant', errorMsg);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            addMessage('assistant', 'Sorry, I encountered an error. Please try again. If this persists, please refresh the page.');
        } finally {
            // Re-enable input
            chatInput.disabled = false;
            sendButton.disabled = false;
            loading.classList.remove('show');
            chatInput.focus();
        }
    });

    function addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const label = document.createElement('div');
        label.className = 'message-label';
        label.textContent = role === 'user' ? 'You' : 'Pediatrician';
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        
        // Format the content - preserve line breaks and format markdown-style text
        let formattedContent = content;
        
        // Convert markdown headings to HTML headings
        formattedContent = formattedContent.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
        formattedContent = formattedContent.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
        formattedContent = formattedContent.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
        formattedContent = formattedContent.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
        
        // Convert **bold** to <strong>
        formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Split content into sections (text and potential lists)
        const lines = formattedContent.split('\n');
        let result = [];
        let currentList = [];
        let currentParagraph = [];
        let inList = false;
        
        for (let i = 0; i < lines.length; i++) {
            const originalLine = lines[i];
            const trimmedLine = originalLine.trim();
            
            // Check if line is a heading (already converted to h1-h4)
            if (trimmedLine.match(/^<h[1-4]>/) || trimmedLine.match(/^<h[1-4]>.*<\/h[1-4]>$/)) {
                // If we have accumulated paragraph text, add it first
                if (currentParagraph.length > 0) {
                    result.push('<p>' + currentParagraph.join('<br>') + '</p>');
                    currentParagraph = [];
                }
                // If we have a list, close it
                if (currentList.length > 0) {
                    result.push('<ul>' + currentList.join('') + '</ul>');
                    currentList = [];
                    inList = false;
                }
                // Add heading directly
                result.push(trimmedLine);
            }
            // Check if line is a sub-item (starts with "- ")
            else if (trimmedLine.match(/^-\s+(.+)$/)) {
                const subMatch = trimmedLine.match(/^-\s+(.+)$/);
                if (subMatch && currentList.length > 0) {
                    // Add as nested sub-item under the last list item
                    const lastIndex = currentList.length - 1;
                    const lastItem = currentList[lastIndex];
                    
                    // Check if last item already has a nested list
                    if (lastItem.includes('</ul></li>')) {
                        // Append to existing nested list (before the closing </ul>)
                        const insertPos = lastItem.lastIndexOf('</ul>');
                        currentList[lastIndex] = lastItem.substring(0, insertPos) + 
                            '<li>' + subMatch[1] + '</li>' + 
                            lastItem.substring(insertPos);
                    } else if (lastItem.endsWith('</li>')) {
                        // Create new nested list inside the last item
                        currentList[lastIndex] = lastItem.replace('</li>', '<ul><li>' + subMatch[1] + '</li></ul></li>');
                    }
                } else if (subMatch) {
                    // No parent list, start a new list
                    currentList.push('<li>' + subMatch[1] + '</li>');
                    inList = true;
                }
            }
            // Check if line is a numbered list item (1. text) - convert to bullet points
            else if (trimmedLine.match(/^(\d+)\.\s+(.+)$/)) {
                const listMatch = trimmedLine.match(/^(\d+)\.\s+(.+)$/);
                // If we have accumulated paragraph text, add it first
                if (currentParagraph.length > 0) {
                    result.push('<p>' + currentParagraph.join('<br>') + '</p>');
                    currentParagraph = [];
                }
                // Add to current list (using ul for bullet points instead of ol)
                currentList.push('<li>' + listMatch[2] + '</li>');
                inList = true;
            } else {
                // If we have a list, close it (using ul for bullet points)
                if (currentList.length > 0) {
                    result.push('<ul>' + currentList.join('') + '</ul>');
                    currentList = [];
                    inList = false;
                }
                // Add to current paragraph (but skip if it's empty or just whitespace)
                if (trimmedLine && !trimmedLine.match(/^<h[1-4]>/)) {
                    currentParagraph.push(trimmedLine);
                } else if (currentParagraph.length > 0 && !trimmedLine) {
                    // Empty line - close current paragraph
                    result.push('<p>' + currentParagraph.join('<br>') + '</p>');
                    currentParagraph = [];
                }
            }
        }
        
        // Close any remaining list or paragraph (using ul for bullet points)
        if (currentList.length > 0) {
            result.push('<ul>' + currentList.join('') + '</ul>');
        }
        if (currentParagraph.length > 0) {
            result.push('<p>' + currentParagraph.join('<br>') + '</p>');
        }
        
        // If no formatting was applied, just wrap in paragraph with line breaks
        if (result.length === 0) {
            formattedContent = '<p>' + formattedContent.replace(/\n/g, '<br>') + '</p>';
        } else {
            formattedContent = result.join('');
        }
        
        bubble.innerHTML = formattedContent;
        
        messageDiv.appendChild(label);
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Focus input on load
    chatInput.focus();
    
    // Handle End Appointment button
    const endAppointmentBtn = document.getElementById('endAppointmentBtn');
    endAppointmentBtn.addEventListener('click', async function() {
        if (confirm('Are you sure you want to end this appointment? Your appointment summary will be saved and you can view it on the Reports page.')) {
            // Disable button and show loading state
            endAppointmentBtn.disabled = true;
            endAppointmentBtn.textContent = 'Saving...';
            
            try {
                // Extract all information (diet, toileting, sleep, development, social, concerns) before redirecting
                await extractDietInfo();
                // Small delay to ensure database is updated
                await new Promise(resolve => setTimeout(resolve, 500));
                window.location.href = '{{ url_for("reports_page") }}';
            } catch (error) {
                console.error('Error extracting information:', error);
                // Even if extraction fails, still redirect (data might have been partially saved)
                alert('Appointment ended. Some information may not have been saved. You can still view your appointment on the Reports page.');
                window.location.href = '{{ url_for("reports_page") }}';
            }
        }
    });
    
    // Add initial greeting message with proper formatting
    const patientName = '{{ appointment.patient_name }}';
    
    let initialMessage = `Hello! Before we begin, could you tell me your name and your relationship to ${patientName}?`;
    addMessage('assistant', initialMessage);
    
    // Function to extract diet information
    async function extractDietInfo() {
        try {
            const response = await fetch('{{ url_for("extract_diet") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error extracting diet info:', error);
            throw error;
        }
    }
    </script>
    {% endblock %}

